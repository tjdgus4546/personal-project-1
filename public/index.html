<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
        <style>
        .hidden { display: none; }
        </style>
</head>
<body>
    <button id="signupBtn" onclick="location.href='/signup'">회원가입</button>
    <button id="loginBtn" onclick="location.href='/login'">로그인</button>
    <button id="logoutBtn">로그아웃</button>
    <button id="quizListBtn" onclick="location.href='/quiz/list-page'">퀴즈 리스트</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/my-list'">나의 퀴즈</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/init'">퀴즈 만들기</button>

    
    <!-- <button onclick="location.href='/helpId'">아이디 찾기</button>
    <button onclick="location.href='/helpPassword'">비밀번호 찾기</button> -->

    <h1 id="greeting">환영합니다!</h1>
    <div id="inviteSection" style="display: none;">
        <input type="text" id="inviteInput" placeholder="초대 코드 입력">
        <button onclick="joinByInvite()">입장</button>
    </div>

    <script>
    async function joinByInvite() {
    const code = document.getElementById('inviteInput').value.trim();
    if (!code) return alert('초대 코드를 입력하세요');

    try {
        const res = await fetch('/game/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-requested-with': 'XMLHttpRequest' // AJAX 요청임을 서버에 알림
            },
            body: JSON.stringify({ inviteCode: code }),
            credentials: 'include'
        });

        const result = await res.json();

        if (res.ok) {
            alert('세션에 참여했습니다! 퀴즈 방으로 이동합니다.');
            window.location.href = `/quiz/${result.sessionId}`;
        } else {
            // 서버에서 보낸 에러 메시지를 표시
            alert(result.message || '입장에 실패했습니다. 코드를 다시 확인해주세요.');
        }
    } catch (err) {
        console.error('Join session error:', err);
        alert('입장 중 오류가 발생했습니다.');
    }
    }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => { // Made async to use await
            // const token = localStorage.getItem('token'); // REMOVED
            const signupBtn = document.getElementById('signupBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const quizListBtn = document.getElementById('quizListBtn');
            const quizCreateBtn = document.getElementById('quizCreateBtn');
            const greeting = document.getElementById('greeting');
            const inviteSection = document.getElementById('inviteSection'); // Define inviteSection

            let isLoggedIn = false; // New variable to track login status

            try {
                const response = await fetch('/my-info', {
                    credentials: 'include' // Added credentials: 'include'
                });

                if (response.ok) {
                    const user = await response.json();
                    if (user.username) {
                        greeting.textContent = `${user.username}님 환영합니다!`;
                        isLoggedIn = true;
                    }
                } else if (response.status === 401 || response.status === 403) {
                    // Token expired or unauthorized, user is not logged in
                    console.warn('세션 만료 또는 인증 실패');
                    // No need to remove from localStorage, as we are using HttpOnly cookies
                } else {
                    throw new Error('서버 응답 오류');
                }
            } catch (err) {
                console.error('유저 정보 불러오기 실패:', err);
                // Assume not logged in if there's an error fetching user info
            }

            if (isLoggedIn) {
                // 로그인 상태
                signupBtn.style.display = 'none';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                quizListBtn.style.display = 'inline-block';
                quizCreateBtn.style.display = 'inline-block';
                inviteSection.style.display = 'block';
            } else {
                // 로그아웃 상태
                signupBtn.style.display = 'inline-block';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                quizListBtn.style.display = 'none';
                quizCreateBtn.style.display = 'none';
                inviteSection.style.display = 'none';
                greeting.textContent = '로그인이 필요합니다.';
            }

            // 로그아웃 버튼 클릭 이벤트
            logoutBtn.addEventListener('click', async () => { // Made async
                try {
                    const response = await fetch('/auth/logout', { // Call the new logout endpoint
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        localStorage.removeItem('username'); // Still remove username from localStorage if stored
                        localStorage.removeItem('userId'); // Still remove userId from localStorage if stored
                        alert('로그아웃 되었습니다.');
                        window.location.reload(); // Reload page to update UI
                    } else {
                        alert('로그아웃 실패');
                    }
                } catch (err) {
                    console.error('로그아웃 에러:', err);
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            });
        });
    </script>
</body>
</html>