<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
        <style>
        .hidden { display: none; }
        </style>
</head>
<body>
    <button id="signupBtn" onclick="location.href='/signup'">회원가입</button>
    <button id="loginBtn" onclick="location.href='/login'">로그인</button>
    <button id="logoutBtn">로그아웃</button>
    <button id="quizListBtn" onclick="location.href='/quiz/list-page'">퀴즈 리스트</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/my-list'">나의 퀴즈</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/init'">퀴즈 만들기</button>

    
    <!-- <button onclick="location.href='/helpId'">아이디 찾기</button>
    <button onclick="location.href='/helpPassword'">비밀번호 찾기</button> -->

    <h1 id="greeting">환영합니다!</h1>
    <div id="inviteSection" style="display: none;">
        <input type="text" id="inviteInput" placeholder="초대 코드 입력">
        <button onclick="joinByInvite()">입장</button>
    </div>

    <script>
    async function joinByInvite() {
    const code = document.getElementById('inviteInput').value.trim();
    if (!code) return alert('초대 코드를 입력하세요');

    try {
        const res = await fetch('/game/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-requested-with': 'XMLHttpRequest' // AJAX 요청임을 서버에 알림
            },
            body: JSON.stringify({ inviteCode: code }),
            credentials: 'include'
        });

        const result = await res.json();

        if (res.ok) {
            alert('세션에 참여했습니다! 퀴즈 방으로 이동합니다.');
            window.location.href = `/quiz/${result.sessionId}`;
        } else {
            // 서버에서 보낸 에러 메시지를 표시
            alert(result.message || '입장에 실패했습니다. 코드를 다시 확인해주세요.');
        }
    } catch (err) {
        console.error('Join session error:', err);
        alert('입장 중 오류가 발생했습니다.');
    }
    }
    </script>

    <script>
        // 401 에러 시 자동으로 토큰 재발급을 시도하는 fetch 래퍼 함수
        async function fetchWithAuth(url, options = {}) {
            // 모든 인증 요청에 credentials 포함
            options.credentials = 'include';

            let response = await fetch(url, options);

            // 액세스 토큰 만료 시 (401 Unauthorized)
            if (response.status === 401) {
                console.log('액세스 토큰 만료. 재발급을 시도합니다.');

                // 새로운 토큰을 요청
                const refreshResponse = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'include'
                });

                // 토큰 재발급 성공 시
                if (refreshResponse.ok) {
                    console.log('토큰 재발급 성공. 원래 요청을 재시도합니다.');
                    // 원래 요청을 새로운 토큰으로 재시도
                    response = await fetch(url, options);
                } else {
                    console.log('리프레시 토큰 만료. 로그아웃 처리합니다.');
                    // 재발급 실패 시 (리프레시 토큰도 만료됨)
                    // 호출한 쪽에서 이 응답을 받아 로그아웃 처리 등을 할 수 있도록 실패 응답을 그대로 반환
                    return refreshResponse;
                }
            }

            return response;
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const signupBtn = document.getElementById('signupBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const quizListBtn = document.getElementById('quizListBtn');
            const quizCreateBtn = document.getElementById('quizCreateBtn');
            const greeting = document.getElementById('greeting');
            const inviteSection = document.getElementById('inviteSection');

            let isLoggedIn = false;

            try {
                // 새로 만든 fetchWithAuth 함수를 사용
                const response = await fetchWithAuth('/my-info');

                if (response.ok) {
                    const user = await response.json();
                    if (user.username) {
                        greeting.textContent = `${user.username}님 환영합니다!`;
                        isLoggedIn = true;
                    }
                } else {
                    // fetchWithAuth 내부에서 재발급까지 실패한 경우
                    console.warn('최종 인증 실패. 로그인이 필요합니다.');
                }
            } catch (err) {
                console.error('유저 정보 불러오기 실패:', err);
            }

            if (isLoggedIn) {
                // 로그인 상태
                signupBtn.style.display = 'none';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                quizListBtn.style.display = 'inline-block';
                quizCreateBtn.style.display = 'inline-block';
                inviteSection.style.display = 'block';
            } else {
                // 로그아웃 상태
                signupBtn.style.display = 'inline-block';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                quizListBtn.style.display = 'none';
                quizCreateBtn.style.display = 'none';
                inviteSection.style.display = 'none';
                greeting.textContent = '로그인이 필요합니다.';
            }

            // 로그아웃 버튼 클릭 이벤트
            logoutBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        alert('로그아웃 되었습니다.');
                        window.location.reload();
                    } else {
                        alert('로그아웃 실패');
                    }
                } catch (err) {
                    console.error('로그아웃 에러:', err);
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            });
        });
    </script>
</body>
</html>