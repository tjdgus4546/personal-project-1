<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
        <style>
        .hidden { display: none; }
        </style>
</head>
<body>
    <button id="signupBtn" onclick="location.href='/signup'">회원가입</button>
    <button id="loginBtn" onclick="location.href='/login'">로그인</button>
    <button id="logoutBtn">로그아웃</button>
    <button id="quizListBtn" onclick="location.href='/quiz/list-page'">퀴즈 리스트</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/my-list'">나의 퀴즈</button>
    <button id="quizCreateBtn" onclick="location.href='/quiz/init'">퀴즈 만들기</button>

    
    <!-- <button onclick="location.href='/helpId'">아이디 찾기</button>
    <button onclick="location.href='/helpPassword'">비밀번호 찾기</button> -->

    <h1 id="greeting">환영합니다!</h1>
    <div id="inviteSection" style="display: none;">
        <input type="text" id="inviteInput" placeholder="초대 코드 입력">
        <button onclick="joinByInvite()">입장</button>
    </div>

    <script>
    async function joinByInvite() {
    const code = document.getElementById('inviteInput').value.trim();
    if (!code) return alert('초대 코드를 입력하세요');

    try {
        const res = await fetch('/game/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-requested-with': 'XMLHttpRequest' // AJAX 요청임을 서버에 알림
            },
            body: JSON.stringify({ inviteCode: code }),
            credentials: 'include'
        });

        const result = await res.json();

        if (res.ok) {
            window.location.href = `/quiz/${result.sessionId}`;
        } else {
            // 서버에서 보낸 에러 메시지를 표시
            alert(result.message || '입장에 실패했습니다. 코드를 다시 확인해주세요.');
        }
    } catch (err) {
        console.error('Join session error:', err);
        alert('입장 중 오류가 발생했습니다.');
    }
    }
    </script>

    <script type="module">
        import { getUserData } from '/js/auth.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const signupBtn = document.getElementById('signupBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const quizListBtn = document.getElementById('quizListBtn');
            const quizCreateBtn = document.getElementById('quizCreateBtn');
            const greeting = document.getElementById('greeting');
            const inviteSection = document.getElementById('inviteSection');

            const user = await getUserData();

            if (user) {
                // 로그인 상태
                greeting.textContent = `${user.username}님 환영합니다!`;
                signupBtn.style.display = 'none';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                quizListBtn.style.display = 'inline-block';
                quizCreateBtn.style.display = 'inline-block';
                inviteSection.style.display = 'block';
            } else {
                // 로그아웃 상태
                greeting.textContent = '로그인이 필요합니다.';
                signupBtn.style.display = 'inline-block';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                quizListBtn.style.display = 'none';
                quizCreateBtn.style.display = 'none';
                inviteSection.style.display = 'none';
            }

            // 로그아웃 버튼 클릭 이벤트
            logoutBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        alert('로그아웃 되었습니다.');
                        window.location.reload();
                    } else {
                        alert('로그아웃 실패');
                    }
                } catch (err) {
                    console.error('로그아웃 에러:', err);
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            });
        });
    </script>
</body>
</html>