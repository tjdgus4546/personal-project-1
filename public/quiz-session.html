<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í€´ì¦ˆ ì„¸ì…˜</title>
    <style>
    .hidden { display: none; }
    </style>
</head>
<body>
  <button id="outBtn" onclick="location.href='/'">ë‚˜ê°€ê¸°</button>
  <button id="forceSkipBtn" class="hidden">ê°•ì œìŠ¤í‚µ</button>
  <button id="voteSkipBtn" class="hidden">ìŠ¤í‚µíˆ¬í‘œ</button>
    
  <h1>ì‹¤ì‹œê°„ í€´ì¦ˆ ì„¸ì…˜</h1>

    <!-- âœ… ëŒ€ê¸° í™”ë©´ -->
  <div id="lobbySection">
    <h2>ê²Œì„ ëŒ€ê¸° ì¤‘...</h2>
    <p>ì´ˆëŒ€ì½”ë“œ: <span id="inviteCode">ë¡œë”©ì¤‘...</span></p>
    <p>ì°¸ê°€ì ëª©ë¡:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" class="hidden">ê²Œì„ì‹œì‘</button>
  </div>

  <!-- âœ… ê²Œì„ í™”ë©´ -->
  <div id="gameSection" class="hidden">
    <p id="countdown">ë‚¨ì€ ì‹œê°„: </p>
    <div id="questionBox"></div>

    <div id="chatLog"></div>

    <form id="chatForm" onsubmit="event.preventDefault(); sendMessage();">
      <input type="text" id="chatInput" placeholder="ë©”ì„¸ì§€ ì…ë ¥">
      <button onclick="sendMessage()">ì „ì†¡</button>
    </form>

    <h2>í˜„ì¬ ì ìˆ˜íŒ</h2>
    <ul id="scoreboard"></ul>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let questions = [];
    let currentIndex = 0;
    let questionTimer = null;
    let host = null;
    let questionStartAt  = null;
    let countdownInterval = null;

    const socket = io();
    const sessionId = new URLSearchParams(window.location.search).get('id');
    const username = localStorage.getItem('username') || 'ìµëª…';

    function isHost() {
      return username === host;
    }

    const lobbySection = document.getElementById('lobbySection');
    const gameSection = document.getElementById('gameSection');
    const startBtn = document.getElementById('startBtn');
    const playerList = document.getElementById('playerList');
    const voteSkipBtn = document.getElementById('voteSkipBtn');
    const forceSkipBtn = document.getElementById('forceSkipBtn');

    //ìŠ¤ì½”ì–´ í‘œì‹œë¶€ë¶„
    socket.on('scoreboard', ({ players }) => {

      const board = document.getElementById('scoreboard');
      board.innerHTML = ''; // ì´ˆê¸°í™”
      players
        .sort((a, b) => b.score - a.score) // ì ìˆ˜ìˆœ ì •ë ¬
        .forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.username}: ${p.score}ì `;
          board.appendChild(li);
        });
    });

    //ìƒˆë¡œê³ ì¹¨ì‹œ ì›ë˜ ìƒíƒœ ìœ ì§€
    fetch(`/game/session/${sessionId}`)
    .then(res => res.json())
    .then(data => {
      questions = data.quiz.questions;
      currentIndex = data.currentQuestionIndex;
      questionStartAt = new Date(data.questionStartAt);
      host = data.host;
      const inviteCode = data.inviteCode || 'ì—†ìŒ';
      document.getElementById('inviteCode').textContent = inviteCode;

      const board = document.getElementById('scoreboard');
      board.innerHTML = '';
      data.players
        .sort((a, b) => b.score - a.score)
        .forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.username}: ${p.score}ì `;
          board.appendChild(li);
        });

      if (data.isStarted) {
        lobbySection.classList.add('hidden');
        gameSection.classList.remove('hidden');
        voteSkipBtn.classList.remove('hidden');
        if (username === data.host) {
          forceSkipBtn.classList.remove('hidden');
        }

        // âœ… ì •ë‹µì´ ì´ë¯¸ ê³µê°œëœ ìƒíƒœë¼ë©´
        if (data.revealedAt) {
          const elapsed = (Date.now() - new Date(data.revealedAt)) / 1000;
          const wait = Math.max(0, 5 - elapsed);

          const answer = questions[currentIndex]?.answer;
          if (answer) {
            const p = document.createElement('p');
            p.textContent = `âœ… ì •ë‹µ ê³µê°œ: ${answer}`;
            p.style.color = 'green';
            document.getElementById('questionBox').appendChild(p);
          }

          window.__isRevealingAnswer = true;

          // 5ì´ˆê°€ ì•ˆ ì§€ë‚¬ë‹¤ë©´, ë‚¨ì€ ì‹œê°„ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ
          if (wait > 0) {
            setTimeout(() => {
              window.__isRevealingAnswer = false;
              if (isHost()) {
                socket.emit('nextQuestion', { sessionId, username });
              }
            }, wait * 1000);
          } else {
            // ì´ë¯¸ 5ì´ˆ ì§€ë‚¬ìœ¼ë©´ ë°”ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ê²¨
            if (isHost()) {
              socket.emit('nextQuestion', { sessionId, username });
            }
          }
        } else {
          showQuestion(); // ì •ë‹µ ê³µê°œ ì¤‘ì´ ì•„ë‹ˆë©´ ê·¸ëƒ¥ ë¬¸ì œ í‘œì‹œ
        }
      }
    });

    // ì„¸ì…˜ ì…ì¥
    socket.emit('joinSession', { sessionId, username });
    
    // ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`/game/chat/${sessionId}`)
      .then(res => res.json())
      .then(data => {
        const chatLog = document.getElementById('chatLog');
        data.messages.forEach(msg => {
          const p = document.createElement('p');
          p.innerHTML = `${msg.username}: ${msg.message}`;
          chatLog.appendChild(p);
        });
      })
      .catch(err => console.error('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err));

    // ëŒ€ê¸°ì‹¤ ìˆ˜ì‹ 
    socket.on('waiting-room', ({ host, players, isStarted }) => {
      playerList.innerHTML = '';
      players.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        playerList.appendChild(li);
      });

      // ë°©ì¥ì¸ ê²½ìš° ì‹œì‘ ë²„íŠ¼ ë³´ì´ê¸°
      if (username === host && !isStarted) {
        startBtn.classList.remove('hidden');
        startBtn.onclick = () => {
          socket.emit('startGame', { sessionId, username });
          startBtn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        };
      }
    });

    // ê²Œì„ ì‹œì‘ë¨
    socket.on('game-started', ({ quiz, host, questionStartAt: startAt }) => {
      questions = quiz.questions;
      currentIndex = 0;
      questionStartAt = new Date(startAt);

      lobbySection.classList.add('hidden');
      gameSection.classList.remove('hidden');
      voteSkipBtn.classList.remove('hidden');
      
        if (username === host) {
          forceSkipBtn.classList.remove('hidden');
      };
      showQuestion();
    });
    
    //ìŠ¤í‚µíˆ¬í‘œ
    voteSkipBtn.addEventListener('click', () => {
      socket.emit('voteSkip', { sessionId, username });
    });

    //ë°©ì¥ ê°•ì œìŠ¤í‚µ
    forceSkipBtn.addEventListener('click', () => {
      socket.emit('forceSkip', { sessionId, username });
    });
  
    //ë¬¸ì œ ë„˜ê¸°ê¸°
    socket.on('next', ({ index, questionStartAt: startTime }) => {
      currentIndex = index;
      questionStartAt  = new Date(startTime); 
      showQuestion();
    });

    //ë©”ì„¸ì§€ ì…ë ¥ì‹œ ì •ë‹µì¸ì§€ ì¼ë°˜ì±„íŒ…ì¸ì§€ íŒë³„
    function sendMessage() {
      if (window.__isRevealingAnswer) return; // ì •ë‹µê³µê°œ ì¤‘ ì •ë‹µì¸ì¦ ì°¨ë‹¨

      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      input.value = '';

      if (!message) return;

      const correctAnswer = questions[currentIndex].answer.trim().toLowerCase().replace(/\s+/g, '');
      const userInput = message.trim().toLowerCase().replace(/\s+/g, '');
      const chatLog = document.getElementById('chatLog');

      if (userInput === correctAnswer) {
        // ì •ë‹µì¼ ê²½ìš°
        socket.emit('correct', { sessionId, username });
      } else {
        // ì¼ë°˜ ì±„íŒ…ì¼ ê²½ìš° DBì— ì €ì¥ ìš”ì²­
        socket.emit('chatMessage', { sessionId, username, message });
        const p = document.createElement('p');
        p.innerHTML = `${username}: ${message}`;
        document.getElementById('chatLog').appendChild(p);
      }
    }

    //ì •ë‹µì‹œ ì¤‘ë³µ ë°©ì§€í•˜ì—¬ ì¶œë ¥í•œë‹¤
    socket.on('correct', ({ username }) => {
      const chatLog = document.getElementById('chatLog');
      const p = document.createElement('p');
      p.innerHTML = `${username}: ${username}ë‹˜ì´ ì •ë‹µì„ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ‰`;
      chatLog.appendChild(p);
    });

    // ì„œë²„ì—ì„œ ì ìˆ˜íŒ ì—…ë°ì´íŠ¸ë§Œ ë°›ìœ¼ë©´ ë¨
    socket.on('scoreboard', ({ players }) => {
      const board = document.getElementById('scoreboard');
      board.innerHTML = '';
      players
        .sort((a, b) => b.score - a.score)
        .forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.username}: ${p.score}ì `;
          board.appendChild(li);
        });
    });

    socket.on('end', ({ message }) => {
        alert(message || 'í€´ì¦ˆê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

    socket.on('answerReveal', ({ answer, index, revealedAt }) => {
      showAnswer(answer); // UI í‘œì‹œ

      const elapsed = (Date.now() - new Date(revealedAt).getTime()) / 1000;
      const waitTime = Math.max(0, 5 - elapsed);

      setTimeout(() => {
        if (isHost()) {
          socket.emit('nextQuestion', { sessionId, username });
        }
      }, waitTime * 1000);
    });

    function showAnswer(answer) {
      const box = document.getElementById('questionBox');
      const p = document.createElement('p');
      p.style.color = 'green';
      p.textContent = `âœ… ì •ë‹µ ê³µê°œ: ${answer}`;
      box.appendChild(p);

      window.__isRevealingAnswer = true;

      // í•„ìš”í•˜ë‹¤ë©´ 5ì´ˆ í›„ ìƒíƒœ í•´ì œ
      setTimeout(() => {
        window.__isRevealingAnswer = false;
      }, 5000);
    };
      
    function showQuestion() {
    const box = document.getElementById('questionBox');
    const question = questions[currentIndex];

    if (!question) {
      box.innerHTML = '<p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    let html = `<h2>ë¬¸ì œ #${currentIndex + 1}</h2>`;
    html += `<p>${question.text}</p>`;

    if (question.imageBase64) {
      html += `<img src="${question.imageBase64}" alt="ë¬¸ì œ ì´ë¯¸ì§€" style="max-width: 300px;">`;
    }

    if (question.youtubeUrl) {
      html += `<div style="margin-top: 10px;">
                <iframe width="560" height="315"
                  src="${question.youtubeUrl}"
                  frameborder="0" allowfullscreen></iframe>
              </div>`;
    }

    box.innerHTML = html;

    // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
    if (questionTimer) clearTimeout(questionTimer);
    if (countdownInterval) clearInterval(countdownInterval);

    const timeLimit = question.timeLimit || 90;

    // âœ… ì •í™•í•œ ì‹œê°„ ê³„ì‚° (í•œ ë²ˆë§Œ new Date ì‚¬ìš©)
    const elapsed = (Date.now() - questionStartAt.getTime()) / 1000;
    let remaining = Math.max(0, Math.floor(timeLimit - elapsed));

    const countdownEl = document.getElementById('countdown');
    if (countdownEl) countdownEl.textContent = `ë‚¨ì€ ì‹œê°„: ${remaining}ì´ˆ`;

    countdownInterval = setInterval(() => {
      remaining--;
      if (countdownEl) countdownEl.textContent = `ë‚¨ì€ ì‹œê°„: ${remaining}ì´ˆ`;
      if (remaining <= 0) {
        clearInterval(countdownInterval);
      }
    }, 1000);

    questionTimer = setTimeout(() => {
      if (isHost()) {
        socket.emit('revealAnswer', { sessionId });
      }
    }, remaining * 1000);
  }


  </script>
</body>
</html>
