<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>문제CRUD</title>
</head>
<body>

    <button onclick="location.href='/'">메인으로</button>
    <button onclick="location.href='/quiz/my-list'">나의 퀴즈</button>

    <h2>문제 편집</h2>
    <div id="questionForm">
    <input type="text" id="text" placeholder="문제 내용"><br>
    <div>
        <label>정답 추가:</label>
        <div>
            <input type="text" id="answerInput" placeholder="정답 입력">
            <button onclick="addAnswer()">→</button>
        </div>
        <div id="answersDisplay"></div>
    </div>
    <div>
        <label>오답 추가 (객관식용, 최대 4개)</label>
        <div>
            <input type="text" id="incorrectInput" placeholder="오답 최대 4개">
            <button onclick="addIncorrectAnswer()">→</button>
        </div>
        <div id="incorrectAnswersDisplay"></div>
    </div>
    <input type="number" id="timeLimit" placeholder="제한 시간 (초)"><br>
    <h4>문제 이미지</h4>
    <input type="file" id="imageInput" accept="image/*"><br>
    <h4>정답 이미지</h4>
    <input type="file" id="answerImageInput" accept="image/*"><br>
    <h4>유튜브 문제</h4>
    <input type="text" id="youtubeUrl"><br>
        <div>
            <button onclick="saveQuestion()">문제 저장</button>
        </div>
    </div>

    <ul id="questionList"></ul>
    <button onclick="markQuizComplete()">퀴즈 공개</button>
    <button onclick="markQuizInComplete()">퀴즈 비공개</button>

    <ul id="questionList"></ul>

    <script>
    // Helper function to handle token refresh and retry
    async function fetchWithAuth(url, options = {}) {
        options.credentials = 'include'; // Ensure cookies are sent

        let response = await fetch(url, options);

        if (response.status === 401) {
            // Try to refresh token
            const refreshResponse = await fetch('/auth/refresh', {
                method: 'POST',
                credentials: 'include'
            });

            if (refreshResponse.ok) {
                // Token refreshed, retry original request
                response = await fetch(url, options);
            } else {
                // Refresh failed, redirect to login
                alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                window.location.href = '/login';
                return; // Prevent further execution
            }
        }
        return response;
    }

    const urlParams = new URLSearchParams(location.search);
    const quizId = urlParams.get('quizId');
    let editingQuestionId = null;

    let currentQuestion = {
        answers: [],
        incorrectAnswers: []
    };

    function addAnswer() {
        const input = document.getElementById('answerInput');
        const answer = input.value.trim();

        if (!answer) {
            return;
        }

        if (currentQuestion.answers.includes(answer)) {
            return;
        }

        currentQuestion.answers.push(answer);
        input.value = '';
        updateAnswersDisplay();
    }

    function addIncorrectAnswer() {
        const input = document.getElementById('incorrectInput');
        const incorrect = input.value.trim();
            
        if (!incorrect) {
            return;
        }
            
        if (currentQuestion.incorrectAnswers.includes(incorrect)) {
            return;
        }
            
        if (currentQuestion.incorrectAnswers.length >= 4) {
            alert('오답은 최대 4개까지 추가할 수 있습니다.');
            return;
        }
            
        currentQuestion.incorrectAnswers.push(incorrect);
        input.value = '';
        updateIncorrectAnswersDisplay();
    }

    function updateAnswersDisplay() {
        const display = document.getElementById('answersDisplay');
        display.innerHTML = '';

        currentQuestion.answers.forEach((answer, index) => {
            const span = document.createElement('span');
            span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
            span.innerHTML = `
                ${answer}
                <button onclick="removeAnswer(${index})" class="ml-2 text-green-600 hover:text-green-500">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
            `;
            display.appendChild(span);
        });
    }

    // 오답 목록 화면 업데이트
    function updateIncorrectAnswersDisplay() {
        const display = document.getElementById('incorrectAnswersDisplay');
        display.innerHTML = '';
            
        currentQuestion.incorrectAnswers.forEach((incorrect, index) => {
            const span = document.createElement('span');
            span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
            span.innerHTML = `
                ${incorrect} 
                <button onclick="removeIncorrectAnswer(${index})" class="ml-2 text-red-600 hover:text-red-500">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>                        </svg>
                    </svg>
                </button>
                `;
            display.appendChild(span);
        });
    }

            // 정답 제거
    function removeAnswer(index) {
        currentQuestion.answers.splice(index, 1);
        updateAnswersDisplay();
    }

    // 오답 제거
    function removeIncorrectAnswer(index) {
        currentQuestion.incorrectAnswers.splice(index, 1);
        updateIncorrectAnswersDisplay();
    }

    // Enter 키로 추가
    document.getElementById('answerInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addAnswer();
        }
    });

    document.getElementById('incorrectInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addIncorrectAnswer();
        }
    });

    async function saveQuestion() {
            const text = document.getElementById('text').value.trim();
            const timeLimit = parseInt(document.getElementById('timeLimit').value) || 90;
            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
            const imageFile = document.getElementById('imageInput').files[0];
            const answerImageFile = document.getElementById('answerImageInput').files[0];

            // 유효성 검사
            if (!text) {
                alert('문제 내용을 입력해주세요.');
                return;
            }

            if (currentQuestion.answers.length === 0) {
                alert('정답을 최소 1개 입력해주세요.');
                return;
            }

            // 이미지 처리
            let imageBase64 = null;
            let answerImageBase64 = null;

            if (imageFile) {
                try {
                    imageBase64 = await resizeImageToBase64(imageFile);
                } catch (err) {
                    alert(err.message);
                    return;
                }
            }

            if (answerImageFile) {
                try {
                    answerImageBase64 = await resizeImageToBase64(answerImageFile);
                } catch (err) {
                    alert(err.message);
                    return;
                }
            }

            const questionData = {
                text,
                answers: currentQuestion.answers,
                incorrectAnswers: currentQuestion.incorrectAnswers,
                timeLimit,
                youtubeUrl,
                imageBase64,
                answerImageBase64
            };

            try {
                const res = await fetchWithAuth(`/api/quiz/${quizId}/add-question`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(questionData)
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('문제가 저장되었습니다!');
                    clearForm(); // 폼 초기화
                    loadQuestions(); // 목록 새로고침
                } else {
                    alert('문제 저장 실패: ' + data.message);
                }
            } catch (error) {
                alert('문제 저장 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function clearForm() {
            document.getElementById('text').value = '';
            document.getElementById('timeLimit').value = '90';
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('imageInput').value = '';
            document.getElementById('answerImageInput').value = '';
            
            // DOM에 저장된 데이터 초기화
            currentQuestion.answers = [];
            currentQuestion.incorrectAnswers = [];
            
            updateAnswersDisplay();
            updateIncorrectAnswersDisplay();
        }

    // 이미지 압축
    async function resizeImageToBase64(file, maxKB = 240, minKB = 40) {
    return new Promise((resolve, reject) => {
        const sizeMB = file.size / (1024 * 1024);
        if (sizeMB > 6) {
        return reject(new Error('6MB를 초과한 이미지는 업로드할 수 없습니다.'));
        }

        const reader = new FileReader();

        reader.onload = function (event) {
        const img = new Image();

        img.onload = function () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            const tryResize = (scale = 1.0) => {
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            let qualities = [];

            if (sizeMB >= 4) {
                qualities = [0.3, 0.1, 0.05, 0.03];
            } else if (sizeMB >= 1) {
                qualities = [0.8, 0.7, 0.6, 0.5, 0.4];
            } else {
                qualities = [0.9, 0.85, 0.8, 0.75, 0.7];
            }

            for (let q of qualities) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const base64 = canvas.toDataURL('image/jpeg', q);
                const sizeInKB = Math.round((base64.length * 3) / 4 / 1024);

                if (sizeInKB <= maxKB && sizeInKB >= minKB) {
                console.log(`✔ 압축 성공: ${sizeInKB}KB (q=${q}, scale=${scale})`);
                resolve(base64);
                return true;
                }
            }

            return false;
            };

            // 점진적 스케일 다운
            const scales = [1.0, 0.9, 0.8, 0.7];
            for (let s of scales) {
            if (tryResize(s)) return;
            }

            // ⚠️ fallback: scale 0.5 + quality 0.3
            canvas.width = img.width * 0.5;
            canvas.height = img.height * 0.5;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const fallback = canvas.toDataURL('image/jpeg', 0.3);
            const fallbackSize = Math.round((fallback.length * 3) / 4 / 1024);
            console.warn(`⚠️ fallback 사용: ${fallbackSize}KB`);
            resolve(fallback);
        };

        img.onerror = reject;
        img.src = event.target.result;
        };

        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
    }

    async function loadQuestions() {
        const res = await fetchWithAuth(`/api/quiz/${quizId}`);
        const data = await res.json();
        const list = document.getElementById('questionList');
        list.innerHTML = '';

        data.questions.forEach(q => {
            try {
                const li = document.createElement('li');
                
                const content = document.createElement('span');
                li.textContent = `${q.order}. ${q.text} (제한시간: ${q.timeLimit || 15}초) `;

                // 삭제 버튼
                const delBtn = document.createElement('button');
                delBtn.textContent = '삭제';
                delBtn.onclick = async () => {
                if (confirm('정말 삭제할까요?')) {
                    // const token = localStorage.getItem('token'); // REMOVED
                    const res = await fetchWithAuth(`/api/quiz/${quizId}/question/${q._id}`, { // Changed to fetchWithAuth
                    method: 'DELETE',
                    });
                    const data = await res.json();
                    alert(data.message);
                    loadQuestions();
                }
                };
                
                li.appendChild(content);
                li.appendChild(delBtn);
                list.appendChild(li);
            } catch (error) {
                console.error('문제 로드 실패:', error);
            }
            
        });
    }

    async function markQuizComplete() {
        const res = await fetchWithAuth(`/api/quiz/${quizId}/complete`, { 
            method: 'POST',
        });
        if (res.ok) {
            alert('퀴즈가 공개되었습니다!');
        } else {
            const errorData = await res.json();
            alert(errorData.message || '퀴즈 공개에 실패했습니다.');
        }
        }

    async function markQuizInComplete() {
        const res = await fetchWithAuth(`/api/quiz/${quizId}/incomplete`, { // Changed to fetchWithAuth
            method: 'PUT',
            // headers: { 'Authorization': `Bearer ${token}` } // REMOVED
        });
        if (res.ok) {
            alert('퀴즈가 비공개되었습니다!');
        } else {
            alert('비공개 실패');
        }
    }

    loadQuestions();
    </script>

</body>
</html>