<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나의 퀴즈</title>
</head>
<body>

<button onclick="location.href='/'">메인으로</button>
<button onclick="location.href='/quiz/my-list'">나의 퀴즈</button>

<h2>나의 퀴즈</h2>
<ul id="quizList"></ul>

<script>
  // Helper function to handle token refresh and retry
  async function fetchWithAuth(url, options = {}) {
      options.credentials = 'include'; // Ensure cookies are sent

      let response = await fetch(url, options);

      if (response.status === 401) {
          // Try to refresh token
          const refreshResponse = await fetch('/auth/refresh', {
              method: 'POST',
              credentials: 'include'
          });

          if (refreshResponse.ok) {
              // Token refreshed, retry original request
              response = await fetch(url, options);
          } else {
              // Refresh failed, redirect to login
              alert('세션이 만료되었습니다. 다시 로그인해주세요.');
              window.location.href = '/login';
              return; // Prevent further execution
          }
      }
      return response;
  }

  // Initial check for login is now handled by fetchWithAuth on the first API call
  // If the user is not logged in, the first fetchWithAuth call will redirect to login.
  // No need for explicit localStorage.getItem('token') check here.

  fetchWithAuth('/api/quiz/my-list') // Use fetchWithAuth
    .then(res => res.json())
    .then(data => {
      const ul = document.getElementById('quizList');
      if (data.length === 0) return ul.innerHTML = '<li>퀴즈가 없습니다.</li>';

      data.forEach(quiz => {
        const li = document.createElement('li');

        const title = document.createElement('span');
        title.textContent = `${quiz.title} (${quiz.questions.length}문제${quiz.isComplete ? ', 완료됨' : ', 작성중'})`;

        const editBtn = document.createElement('button');
        editBtn.textContent = '제목수정';
        editBtn.onclick = () => {
          const newTitle = prompt('새 제목:', quiz.title);
          const newDesc = prompt('새 설명:', quiz.description || '');
          if (!newTitle) return alert('제목은 필수입니다.');

          fetchWithAuth(`/api/quiz/${quiz._id}`, { // Use fetchWithAuth
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, // Headers still needed for content type
            body: JSON.stringify({ title: newTitle, description: newDesc })
          }).then(r => r.json()).then(result => {
            if (result.message) alert(result.message);
            location.reload();
          });
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '퀴즈삭제';
        deleteBtn.onclick = () => {
          if (confirm('이 퀴즈를 정말 삭제하시겠습니까?')) {
            fetchWithAuth(`/api/quiz/${quiz._id}`, { method: 'DELETE' }) // Use fetchWithAuth
              .then(res => res.json())
              .then(result => {
                alert(result.message);
                location.reload();
              });
          }
        };

        const editLink = document.createElement('a');
        editLink.href = `/quiz/edit?quizId=${quiz._id}`;
        editLink.textContent = '[문제 편집]';

        li.append(title, ' ', editLink, ' ', editBtn, ' ', deleteBtn);
        ul.appendChild(li);
      });
    });
</script>
    
</body>
</html>