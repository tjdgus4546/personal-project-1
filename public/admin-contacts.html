<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>문의 관리 - 관리자</title>
  <link rel="icon" href="/images/favicon.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body class="bg-[#222230] text-white min-h-screen">

  <div class="container max-w-7xl mx-auto px-4 py-8">

    <!-- 헤더 -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-green-400">문의 관리</h1>
          <p class="text-gray-400 mt-2">사용자 문의를 확인하고 답변할 수 있습니다.</p>
        </div>
        <div class="flex gap-3">
          <button onclick="window.location.href='/admin/dashboard'" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
            대시보드로
          </button>
          <button onclick="window.location.href='/'" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
            메인으로
          </button>
        </div>
      </div>
    </div>

    <!-- 상태 필터 -->
    <div class="bg-black/30 rounded-2xl p-6 shadow-xl border border-gray-600 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <div class="text-gray-300 font-medium">상태 필터:</div>
        <button onclick="filterByStatus('all')" id="filter-all" class="status-filter-btn active px-4 py-2 rounded-lg transition-colors bg-blue-500 hover:bg-blue-600">
          전체
        </button>
        <button onclick="filterByStatus('pending')" id="filter-pending" class="status-filter-btn px-4 py-2 rounded-lg transition-colors bg-gray-600 hover:bg-gray-500">
          대기 중
        </button>
        <button onclick="filterByStatus('in_progress')" id="filter-in_progress" class="status-filter-btn px-4 py-2 rounded-lg transition-colors bg-gray-600 hover:bg-gray-500">
          처리 중
        </button>
        <button onclick="filterByStatus('resolved')" id="filter-resolved" class="status-filter-btn px-4 py-2 rounded-lg transition-colors bg-gray-600 hover:bg-gray-500">
          해결됨
        </button>
        <button onclick="filterByStatus('closed')" id="filter-closed" class="status-filter-btn px-4 py-2 rounded-lg transition-colors bg-gray-600 hover:bg-gray-500">
          종료됨
        </button>
      </div>
    </div>

    <!-- 문의 목록 섹션 -->
    <div class="bg-black/30 rounded-2xl p-6 shadow-xl border border-gray-600">

      <!-- 로딩 상태 -->
      <div id="loadingState" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="text-gray-400 mt-4">문의 목록을 불러오는 중...</p>
      </div>

      <!-- 문의 테이블 -->
      <div id="contactTableContainer" class="hidden overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-600">
              <th class="text-left p-3 text-gray-300">상태</th>
              <th class="text-left p-3 text-gray-300">제목</th>
              <th class="text-left p-3 text-gray-300">문의자</th>
              <th class="text-left p-3 text-gray-300">카테고리</th>
              <th class="text-left p-3 text-gray-300">접수일</th>
              <th class="text-center p-3 text-gray-300">작업</th>
            </tr>
          </thead>
          <tbody id="contactList">
            <!-- 문의 목록이 여기에 표시됩니다 -->
          </tbody>
        </table>
      </div>

      <!-- 빈 상태 -->
      <div id="emptyState" class="hidden text-center py-12">
        <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <p class="text-gray-400">문의가 없습니다.</p>
      </div>

      <!-- 페이지네이션 -->
      <div id="paginationContainer" class="hidden mt-6 flex items-center justify-center gap-2">
        <button id="prevPageBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          이전
        </button>
        <span id="pageInfo" class="text-gray-300 px-4">1 / 1</span>
        <button id="nextPageBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          다음
        </button>
      </div>
    </div>

  </div>

  <!-- 문의 상세 모달 -->
  <div id="contactModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-[#2d2d3d] rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6 border border-gray-600">
      <!-- 모달 헤더 -->
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-600">
        <h2 class="text-2xl font-bold text-green-400">문의 상세</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- 문의 정보 -->
      <div class="space-y-4 mb-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-gray-400 text-sm mb-1">문의자</div>
            <div class="text-white font-medium" id="modal-name"></div>
          </div>
          <div>
            <div class="text-gray-400 text-sm mb-1">이메일</div>
            <div class="text-white font-medium" id="modal-email"></div>
          </div>
          <div>
            <div class="text-gray-400 text-sm mb-1">카테고리</div>
            <div class="text-white font-medium" id="modal-category"></div>
          </div>
          <div>
            <div class="text-gray-400 text-sm mb-1">IP 주소</div>
            <div class="text-white font-medium text-sm" id="modal-ip"></div>
          </div>
          <div>
            <div class="text-gray-400 text-sm mb-1">접수일</div>
            <div class="text-white font-medium" id="modal-created"></div>
          </div>
          <div>
            <div class="text-gray-400 text-sm mb-1">상태</div>
            <div id="modal-status"></div>
          </div>
        </div>

        <div>
          <div class="text-gray-400 text-sm mb-1">제목</div>
          <div class="text-white font-medium text-lg" id="modal-subject"></div>
        </div>

        <div>
          <div class="text-gray-400 text-sm mb-1">내용</div>
          <div class="text-white bg-black/30 p-4 rounded-lg whitespace-pre-wrap" id="modal-message"></div>
        </div>
      </div>

      <!-- 답변 섹션 -->
      <div id="responseSection" class="border-t border-gray-600 pt-4">
        <div class="text-gray-400 text-sm mb-2">관리자 답변</div>
        <div id="existingResponse" class="hidden mb-4">
          <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
            <div class="text-green-300 text-sm mb-2">
              답변일: <span id="responded-at"></span> | 답변자: <span id="responded-by"></span>
            </div>
            <div class="text-white whitespace-pre-wrap" id="response-content"></div>
          </div>
        </div>
        <div id="responseForm">
          <textarea
            id="responseInput"
            placeholder="답변을 입력하세요..."
            class="w-full px-4 py-3 bg-[#1a1a24] border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"
            rows="6"
          ></textarea>
          <div class="flex justify-end gap-2 mt-3">
            <button onclick="submitResponse()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium">
              답변 저장
            </button>
          </div>
        </div>
      </div>

      <!-- 상태 변경 -->
      <div class="border-t border-gray-600 pt-4 mt-4">
        <div class="text-gray-400 text-sm mb-2">상태 변경</div>
        <div class="flex gap-2 flex-wrap">
          <button onclick="changeStatus('pending')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors text-sm">
            대기 중
          </button>
          <button onclick="changeStatus('in_progress')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm">
            처리 중
          </button>
          <button onclick="changeStatus('resolved')" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm">
            해결됨
          </button>
          <button onclick="changeStatus('closed')" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm">
            종료됨
          </button>
        </div>
      </div>

      <!-- 삭제 버튼 (superadmin만) -->
      <div id="deleteSection" class="border-t border-gray-600 pt-4 mt-4">
        <button onclick="deleteContact()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm">
          문의 삭제
        </button>
      </div>

    </div>
  </div>

  <script>
    let currentPage = 1;
    let currentStatus = 'all';
    let currentContact = null;

    // 카테고리 한글 변환
    const categoryNames = {
      general: '일반 문의',
      bug: '버그 신고',
      feature: '기능 제안',
      account: '계정 관련',
      other: '기타'
    };

    // 상태 배지 생성
    function getStatusBadge(status) {
      const badges = {
        pending: '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-300 text-xs rounded-full">대기 중</span>',
        in_progress: '<span class="px-2 py-1 bg-blue-500/20 text-blue-300 text-xs rounded-full">처리 중</span>',
        resolved: '<span class="px-2 py-1 bg-green-500/20 text-green-300 text-xs rounded-full">해결됨</span>',
        closed: '<span class="px-2 py-1 bg-gray-500/20 text-gray-300 text-xs rounded-full">종료됨</span>'
      };
      return badges[status] || status;
    }

    // 날짜 포맷
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // 문의 목록 로드
    async function loadContacts() {
      try {
        const response = await fetch(`/admin/contacts?page=${currentPage}&limit=20&status=${currentStatus}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.message);
        }

        const { contacts, pagination } = data;

        const loadingState = document.getElementById('loadingState');
        const tableContainer = document.getElementById('contactTableContainer');
        const emptyState = document.getElementById('emptyState');
        const contactList = document.getElementById('contactList');

        loadingState.classList.add('hidden');

        if (contacts.length === 0) {
          tableContainer.classList.add('hidden');
          emptyState.classList.remove('hidden');
        } else {
          emptyState.classList.add('hidden');
          tableContainer.classList.remove('hidden');

          contactList.innerHTML = contacts.map(contact => `
            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
              <td class="p-3">${getStatusBadge(contact.status)}</td>
              <td class="p-3">
                <div class="font-medium">${contact.subject}</div>
              </td>
              <td class="p-3">
                <div class="text-sm">${contact.name}</div>
                <div class="text-xs text-gray-400">${contact.email}</div>
              </td>
              <td class="p-3 text-sm">${categoryNames[contact.category] || contact.category}</td>
              <td class="p-3 text-sm">${formatDate(contact.createdAt)}</td>
              <td class="p-3 text-center">
                <button
                  onclick="viewContact('${contact._id}')"
                  class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors"
                >
                  상세
                </button>
              </td>
            </tr>
          `).join('');
        }

        // 페이지네이션 업데이트
        updatePagination(pagination);

      } catch (error) {
        console.error('문의 로드 오류:', error);
        alert('문의 목록을 불러오는데 실패했습니다.');
      }
    }

    // 페이지네이션 업데이트
    function updatePagination(pagination) {
      const paginationContainer = document.getElementById('paginationContainer');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const pageInfo = document.getElementById('pageInfo');

      if (pagination.totalPages > 1) {
        paginationContainer.classList.remove('hidden');
        pageInfo.textContent = `${pagination.currentPage} / ${pagination.totalPages}`;

        prevBtn.disabled = pagination.currentPage === 1;
        nextBtn.disabled = !pagination.hasMore;

        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            loadContacts();
          }
        };

        nextBtn.onclick = () => {
          if (pagination.hasMore) {
            currentPage++;
            loadContacts();
          }
        };
      } else {
        paginationContainer.classList.add('hidden');
      }
    }

    // 상태 필터
    function filterByStatus(status) {
      currentStatus = status;
      currentPage = 1;

      // 버튼 스타일 업데이트
      document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-500');
        btn.classList.add('bg-gray-600');
      });

      const activeBtn = document.getElementById(`filter-${status}`);
      activeBtn.classList.add('active', 'bg-blue-500');
      activeBtn.classList.remove('bg-gray-600');

      loadContacts();
    }

    // 문의 상세 보기
    async function viewContact(contactId) {
      try {
        const response = await fetch(`/admin/contacts?page=1&limit=1000&status=all`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.message);
        }

        const contact = data.contacts.find(c => c._id === contactId);
        if (!contact) {
          throw new Error('문의를 찾을 수 없습니다.');
        }

        currentContact = contact;

        // 모달 정보 채우기
        document.getElementById('modal-name').textContent = contact.name;
        document.getElementById('modal-email').textContent = contact.email;
        document.getElementById('modal-category').textContent = categoryNames[contact.category] || contact.category;
        document.getElementById('modal-ip').textContent = contact.ipAddress;
        document.getElementById('modal-created').textContent = formatDate(contact.createdAt);
        document.getElementById('modal-status').innerHTML = getStatusBadge(contact.status);
        document.getElementById('modal-subject').textContent = contact.subject;
        document.getElementById('modal-message').textContent = contact.message;

        // 답변 표시
        const existingResponse = document.getElementById('existingResponse');
        const responseForm = document.getElementById('responseForm');

        if (contact.adminResponse) {
          existingResponse.classList.remove('hidden');
          document.getElementById('responded-at').textContent = formatDate(contact.respondedAt);
          document.getElementById('responded-by').textContent = contact.respondedByUser?.nickname || 'Unknown';
          document.getElementById('response-content').textContent = contact.adminResponse;
          responseForm.classList.add('hidden');
        } else {
          existingResponse.classList.add('hidden');
          responseForm.classList.remove('hidden');
          document.getElementById('responseInput').value = '';
        }

        // 모달 열기
        document.getElementById('contactModal').classList.remove('hidden');

      } catch (error) {
        console.error('문의 상세 로드 오류:', error);
        alert('문의 정보를 불러오는데 실패했습니다.');
      }
    }

    // 모달 닫기
    function closeModal() {
      document.getElementById('contactModal').classList.add('hidden');
      currentContact = null;
    }

    // 답변 저장
    async function submitResponse() {
      if (!currentContact) return;

      const response = document.getElementById('responseInput').value.trim();
      if (!response) {
        alert('답변 내용을 입력해주세요.');
        return;
      }

      if (!confirm('답변을 저장하시겠습니까?')) return;

      try {
        const res = await fetch(`/admin/contacts/${currentContact._id}/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ response })
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.message);
        }

        alert('답변이 저장되었습니다.');
        closeModal();
        loadContacts();

      } catch (error) {
        console.error('답변 저장 오류:', error);
        alert('답변 저장에 실패했습니다: ' + error.message);
      }
    }

    // 상태 변경
    async function changeStatus(newStatus) {
      if (!currentContact) return;

      if (!confirm(`상태를 "${getStatusBadge(newStatus)}"로 변경하시겠습니까?`)) return;

      try {
        const res = await fetch(`/admin/contacts/${currentContact._id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.message);
        }

        alert('상태가 변경되었습니다.');
        closeModal();
        loadContacts();

      } catch (error) {
        console.error('상태 변경 오류:', error);
        alert('상태 변경에 실패했습니다: ' + error.message);
      }
    }

    // 문의 삭제
    async function deleteContact() {
      if (!currentContact) return;

      if (!confirm('정말로 이 문의를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;

      try {
        const res = await fetch(`/admin/contacts/${currentContact._id}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.message);
        }

        alert('문의가 삭제되었습니다.');
        closeModal();
        loadContacts();

      } catch (error) {
        console.error('문의 삭제 오류:', error);
        alert('문의 삭제에 실패했습니다: ' + error.message);
      }
    }

    // 초기 로드
    loadContacts();
  </script>

</body>
</html>
